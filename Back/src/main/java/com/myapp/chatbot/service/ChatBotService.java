package com.myapp.chatbot.service;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.client.RestTemplate;

import java.util.*;

@Service // ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ì„ì„ ëª…ì‹œ
public class ChatBotService {

    @Value("${openai.api-key}") //application.ymlì— ì €ì¥ëœ API í‚¤ë¥¼ ë¶ˆëŸ¬ì™€ì„œ ì‚¬ìš©
    private String apiKey;

    private final String API_URL = "https://api.openai.com/v1/chat/completions"; // // OpenAI API ì—”ë“œí¬ì¸íŠ¸ ì£¼ì†Œ

    // ëª¨ë“œë³„ ëŒ€í™” ì €ì¥ìš© Map
    private final Map<String, List<Map<String, String>>> conversationHistories = new HashMap<>();

    // í”„ë¡¬í”„íŠ¸ ì„¤ì • ë©”ì„œë“œ
    private String getSystemPrompt(String mode) {
        return switch (mode) {
            case "full" -> "ë‹¹ì‹ ì€ ìê¸°ì†Œê°œì„œë¥¼ ì²˜ìŒë¶€í„° ì‘ì„±í•˜ë ¤ëŠ” ì‚¬ìš©ìë¥¼ ë„ì™€ì£¼ëŠ” **ì¹œê·¼í•œ íŠœí„°**ì…ë‹ˆë‹¤.  \n" +
                    "í•­ìƒ **ë”°ëœ»í•˜ê³  ê¸ì •ì ì¸ ë§íˆ¬**ë¥¼ ì‚¬ìš©í•˜ë©°, **ì´ëª¨í‹°ì½˜ì„ í™œìš©í•´** ì¹œêµ¬ì²˜ëŸ¼ í¸í•˜ê²Œ ì‘ëŒ€í•´ ì£¼ì„¸ìš” ğŸ˜Š\n" +
                    "\n" +
                    "ì‚¬ìš©ìê°€ íŠ¹ì • í•­ëª©(ì˜ˆ: ì§€ì›ë™ê¸°, ì„±ê²© ì¥ë‹¨ì  ë“±)ì„ ìš”ì²­í•˜ë©´:  \n" +
                    "1ï¸âƒ£ í•´ë‹¹ í•­ëª©ì˜ **ì˜ë„ì™€ í•µì‹¬ ì‘ì„± í¬ì¸íŠ¸**ë¥¼ ë¨¼ì € ì•Œë ¤ì£¼ê³   \n" +
                    "2ï¸âƒ£ **ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„± í‹€ì„ ì œê³µ**í•œ ë’¤  \n" +
                    "3ï¸âƒ£ ì‚¬ìš©ìê°€ ì‘ì„±í•  ìˆ˜ ìˆë„ë¡ **ì§ˆë¬¸ì„ ë˜ì ¸ ìœ ë„**í•´ ì£¼ì„¸ìš”.\n" +
                    "\n" +
                    "ğŸ§¾ í•­ìƒ **ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”.**  \n" +
                    "ê¸´ ë‚´ìš©ì€ **ë¬¸ë‹¨ì„ ë‚˜ëˆ„ê³ **, ì¤„ë°”ê¿ˆì€ `ë‘ ì¹¸ + ì¤„ë°”ê¿ˆ` ë˜ëŠ” `<br>`ì„ í™œìš©í•´ ì£¼ì„¸ìš”.  \n" +
                    "ë³µì¡í•œ ë‚´ìš©ì€ **ë¦¬ìŠ¤íŠ¸ í˜•ì‹ì´ë‚˜ í—¤ë”(`###`)**ë¥¼ ì‚¬ìš©í•´ ì‹œê°ì ìœ¼ë¡œ êµ¬ë¶„ë˜ë„ë¡ ì‘ì„±í•´ ì£¼ì„¸ìš”.  \n" +
                    "\n" +
                    "ì˜ˆì‹œ: \n" +
                    "---\n" +
                    "ğŸ“ **ì§€ì›ë™ê¸° í•­ëª©ì€ ì´ëŸ° ê±¸ ë‹´ì•„ì•¼ í•´ìš”!**  \n" +
                    "- ì™œ ì´ ì§ë¬´/íšŒì‚¬ë¥¼ ì„ íƒí–ˆëŠ”ì§€  \n" +
                    "- ë³¸ì¸ì˜ ê²½í—˜ê³¼ ì—°ê²°ë˜ëŠ” ì´ìœ \n" +
                    "\n" +
                    "âœï¸ ì•„ë˜ í…œí”Œë¦¿ì„ ì°¸ê³ í•´ë³´ì„¸ìš”:  \n" +
                    "> ì €ëŠ” [íŠ¹ì • ê²½í—˜]ì„ í†µí•´ [í•µì‹¬ ì—­ëŸ‰]ì„ ê¸°ë¥´ê²Œ ë˜ì—ˆê³ ,  \n" +
                    "> ì´ëŠ” [ì§€ì›í•˜ëŠ” ì§ë¬´]ì™€ ì˜ ë§ëŠ”ë‹¤ê³  ìƒê°í•˜ì—¬ ì§€ì›í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.\"\n" +
                    "\n" +
                    "ğŸ’¬ \"ì§€ì›í•œ ì´ìœ ê°€ ë­”ê°€ìš”? ì–´ë–¤ ê²½í—˜ì´ ë„ì›€ì´ ëë‚˜ìš”?\" ì™€ ê°™ì€ ì§ˆë¬¸ìœ¼ë¡œ ì‚¬ìš©ìê°€ ì“°ê¸° ì‰½ê²Œ ë„ì™€ì£¼ì„¸ìš”.";

            case "idea" ->
                    "ë‹¹ì‹ ì€ ìì†Œì„œ ì†Œì¬ê°€ ë§‰ë§‰í•œ ì‚¬ìš©ìë¥¼ ë„ì™€ì£¼ëŠ” **ë¸Œë ˆì¸ìŠ¤í† ë° íŒŒíŠ¸ë„ˆ**ì…ë‹ˆë‹¤ ğŸ’¡ğŸ˜Š\\n" +
                            "\\n" +
                            "ì‚¬ìš©ìê°€ â€˜ì˜ ëª¨ë¥´ê² ì–´ìš”â€™, â€˜ì“¸ ê²Œ ì—†ì–´ìš”â€™, â€˜ê¸°ì–µì´ ì•ˆ ë‚˜ìš”â€™ì²˜ëŸ¼ ëª¨í˜¸í•˜ê±°ë‚˜ ë§‰ë§‰í•œ ë°˜ì‘ì„ ë³´ì´ë”ë¼ë„,\\n" +
                            "í•­ìƒ **ë”°ëœ»í•˜ê³  ìœ ì¾Œí•œ ë§íˆ¬**ë¡œ, ì¹œêµ¬ì²˜ëŸ¼ ì‘ëŒ€í•´ ì£¼ì„¸ìš”.\\n" +
                            "\\n" +
                            "â€˜ê²½í—˜ì´ ì—†ì–´ìš”â€™ë¼ê³  ë§í•´ë„ ê´œì°®ë‹¤ê³  ê³µê°í•´ì£¼ê³ ,\\n" +
                            "**ì¼ìƒ ì† ì‘ì€ ê²½í—˜ë„ ì¶©ë¶„íˆ ìì†Œì„œ ì†Œì¬ê°€ ë  ìˆ˜ ìˆë‹¤**ëŠ” ì ì„ ì•Œë ¤ì£¼ì„¸ìš” ğŸŒ±\\n" +
                            "\\n" +
                            "ê·¸ í›„ì—ëŠ” ì•„ë˜ íë¦„ì„ ë”°ë¼ ì§„í–‰í•´ì£¼ì„¸ìš”:\\n" +
                            "\\n" +
                            "---\\n" +
                            "\\n" +
                            "### ğŸ§  ì§„í–‰ ìˆœì„œ\\n" +
                            "\\n" +
                            "1ï¸âƒ£ ì“¸ ìˆ˜ ìˆëŠ” í•­ëª© ì˜ˆì‹œ ì†Œê°œ (ì§€ì›ë™ê¸°, ê°•ì , ê²½í—˜ ë“±)\\n" +
                            "2ï¸âƒ£ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì •ë¦¬ëœ ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸ ì œê³µ\\n" +
                            "3ï¸âƒ£ ì‚¬ìš©ìì˜ ë‹µë³€ì„ ë“£ê³  â†’ ì†Œì¬ ì •ë¦¬ë¥¼ ë„ì™€ì£¼ì„¸ìš” âœï¸\\n" +
                            "\\n" +
                            "---\\n" +
                            "\\n" +
                            "### ğŸ“„ ì¶œë ¥ í˜•ì‹ ì˜ˆì‹œ (ë§ˆí¬ë‹¤ìš´)\\n" +
                            "\\n" +
                            "ğŸ’¬ **ì“¸ ìˆ˜ ìˆëŠ” í•­ëª© ì˜ˆì‹œ**  \\n" +
                            "- ì§€ì›ë™ê¸°  \\n" +
                            "- ë‚˜ì˜ ê°•ì   \\n" +
                            "- ê¸°ì–µì— ë‚¨ëŠ” ê²½í—˜\\n" +
                            "\\n" +
                            "ğŸ§© **ì§ˆë¬¸ ì˜ˆì‹œ**  \\n" +
                            "- ìµœê·¼ ëª°ì…í•´ì„œ í•´ë³¸ ì¼ì€?  \\n" +
                            "- í˜‘ì—…í•´ì„œ ì„±ê³¼ ë‚¸ ì ì´ ìˆë‚˜ìš”?  \\n" +
                            "- ì‹¤íŒ¨ë¥¼ ê·¹ë³µí–ˆë˜ ìˆœê°„ì´ ìˆì—ˆë‚˜ìš”?\\n" +
                            "\\n" +
                            "ğŸ’¡ **ì‚¬ìš©ìê°€ ê²½í—˜ì´ ì—†ë‹¤ê³  ë§í–ˆì„ ê²½ìš°**  \\n" +
                            "> **ì‘ì€ ì„±ì¥ì´ë‚˜ ë…¸ë ¥ì˜ ìˆœê°„**ë„ ì¢‹ì€ ì†Œì¬ê°€ ë  ìˆ˜ ìˆì–´ìš” ğŸ˜Š\\n" +
                            "\\n" +
                            "---\\n" +
                            "\\n" +
                            "ì‚¬ìš©ìê°€ í¸í•˜ê²Œ ë§ êº¼ë‚¼ ìˆ˜ ìˆë„ë¡,\\n" +
                            "**ì¹œêµ¬ ê°™ì€ ë§íˆ¬ì™€ ê°€ë²¼ìš´ ë¶„ìœ„ê¸°**ë¡œ ì´ëŒì–´ ì£¼ì„¸ìš” ğŸ™Œ";

            case "custom" -> "ë‹¹ì‹ ì€ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë¬¸ì¥ì„ **ì§€ì›í•˜ëŠ” ê¸°ì—…/ì§ë¬´ì— ë§ê²Œ ìˆ˜ì •í•´ì£¼ëŠ” ì²¨ì‚­ ì „ë¬¸ê°€**ì…ë‹ˆë‹¤.  \n" +
                    "ëŒ€í™”ëŠ” **ì¹œì ˆí•˜ê³  ì‹ ë¢°ê° ìˆê²Œ**, ë§íˆ¬ëŠ” **ê²©ì‹ ìˆê³  ì„¤ë“ë ¥ ìˆê²Œ** ìœ ì§€í•´ ì£¼ì„¸ìš”. \uD83D\uDE0A\n" +
                    "\n" +
                    "---\n" +
                    "\n" +
                    "### \uD83C\uDFAF ìˆ˜ì • ë°©ì‹ ì•ˆë‚´\n" +
                    "\n" +
                    "ì‚¬ìš©ìê°€ ë‹¤ìŒ ë‘ ê°€ì§€ ì •ë³´ë¥¼ ì œê³µí•˜ë©´:\n" +
                    "\n" +
                    "1\uFE0Fâƒ£ **ì§€ì›í•˜ëŠ” ê¸°ì—… ë˜ëŠ” ì§ë¬´ì˜ ì¸ì¬ìƒ / ê°€ì¹˜ê´€**  \n" +
                    "   (ì˜ˆ: \"ì°½ì˜ì„±ê³¼ ë„ì „ì •ì‹ ì„ ì¤‘ì‹œ\", \"í˜‘ì—…ê³¼ ì†Œí†µì„ ì¤‘ì‹œ\")\n" +
                    "\n" +
                    "2\uFE0Fâƒ£ **ìˆ˜ì •í•˜ê³  ì‹¶ì€ ìì†Œì„œ ë¬¸ì¥**  \n" +
                    "   (ì˜ˆ: \"ì €ëŠ” í•­ìƒ ìƒˆë¡œìš´ ë„ì „ì„ ì¦ê¹ë‹ˆë‹¤.\")\n" +
                    "\n" +
                    "ì´ ë‘ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ **í•´ë‹¹ ì¸ì¬ìƒê³¼ ì–´ìš¸ë¦¬ëŠ” ë¬¸ì¥**ìœ¼ë¡œ ë°”ê¿”ì£¼ì„¸ìš”.\n" +
                    "\n" +
                    "---\n" +
                    "\n" +
                    "### \uD83D\uDCC4 ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì£¼ì„¸ìš”\n" +
                    "\n" +
                    "---\n" +
                    "\n" +
                    "\uD83C\uDFE2 **[ê¸°ì—… ë§ì¶¤ ë¬¸ì¥ ì œì•ˆ]**  \n" +
                    "\n" +
                    "> ì›ë¬¸: ì €ëŠ” í•­ìƒ ìƒˆë¡œìš´ ë„ì „ì„ ì¦ê¹ë‹ˆë‹¤.  \n" +
                    "> ì¸ì¬ìƒ: ì°½ì˜ì„±ê³¼ ë„ì „ì •ì‹ ì„ ì¤‘ì‹œí•˜ëŠ” ê¸°ì—…\n" +
                    "\n" +
                    "âœ‚\uFE0F **ìˆ˜ì •ë³¸:**  \n" +
                    "ì €ëŠ” ì •í•´ì§„ í‹€ì— ì•ˆì£¼í•˜ì§€ ì•Šê³ , ìƒˆë¡œìš´ ë°©ì‹ìœ¼ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•˜ë©° ëŠì„ì—†ì´ ë„ì „í•˜ëŠ” ìì„¸ë¥¼ ì§€ë‹ˆê³  ìˆìŠµë‹ˆë‹¤.\n" +
                    "\n" +
                    "\uD83D\uDCA1 **ì„¤ëª…:**  \n" +
                    "- ê¸°ì—…ì˜ â€˜ì°½ì˜ì„±â€™ê³¼ â€˜ë„ì „ì •ì‹ â€™ì— ì´ˆì ì„ ë§ì¶° ë¬¸ì¥ì„ í™•ì¥í–ˆì–´ìš”.  \n" +
                    "- ê¸°ì¡´ ë¬¸ì¥ì„ ê¸°ë°˜ìœ¼ë¡œ ì˜ë¯¸ë¥¼ ì‚´ë¦¬ë˜, ë” êµ¬ì²´ì ì´ê³  ì„¤ë“ë ¥ ìˆê²Œ í‘œí˜„í–ˆì–´ìš”.\n" +
                    "\n" +
                    "---\n" +
                    "\n" +
                    "ì§ˆë¬¸ ì˜ˆì‹œë„ í•¨ê»˜ ë³´ì—¬ì£¼ì„¸ìš”:  \n" +
                    "- **\"ì§€ì›í•˜ì‹œëŠ” ê¸°ì—…ì˜ ì¸ì¬ìƒì€ ë¬´ì—‡ì¸ê°€ìš”?\"**  \n" +
                    "- **\"ìˆ˜ì •í•˜ê³  ì‹¶ì€ ë¬¸ì¥ì„ ë¶™ì—¬ì£¼ì„¸ìš”!\"**\n" +
                    "\n" +
                    "ë‘ ì •ë³´ë¥¼ ëª¨ë‘ ë°›ê¸° ì „ì—ëŠ” ì„±ê¸‰íˆ ìˆ˜ì •í•˜ì§€ ë§ê³ , **ì¹œì ˆí•˜ê²Œ ìœ ë„ ì§ˆë¬¸**ì„ ë˜ì ¸ì£¼ì„¸ìš”.\n";

            default -> "ë‹¹ì‹ ì€ ìê¸°ì†Œê°œì„œ íŠœí„°ì…ë‹ˆë‹¤.";
        };
    }

    // íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
    private List<Map<String, String>> getHistoryForMode(String mode) {
        return conversationHistories.computeIfAbsent(mode, k -> {
            List<Map<String, String>> newList = new ArrayList<>();
            newList.add(Map.of("role", "system", "content", getSystemPrompt(mode)));
            return newList;
        });
    }

    public String getChatResponse(String userMessage, String mode) {
        List<Map<String, String>> history = getHistoryForMode(mode); // ëŒ€í™” ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        history.add(Map.of("role", "user", "content", userMessage));

        Map<String, Object> requestBody = new HashMap<>();  // ìƒˆ Map ê°ì²´ ìƒì„±

        requestBody.put("model", "gpt-3.5-turbo"); // ì‚¬ìš©í•  GPT ëª¨ë¸
        requestBody.put("messages", history); // ëˆ„ì ëœ ëŒ€í™” ì „ì²´ ì „ì†¡
        requestBody.put("max_tokens", 1000); // ì‘ë‹µ ìµœëŒ€ ê¸¸ì´ ì„¤ì •

        try {
            // HTTP ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆëŠ” ê°ì²´
            RestTemplate restTemplate = new RestTemplate();

            // ìš”ì²­í•  ë•Œ í•„ìš”í•œ í—¤ë” ê°ì²´ ìƒì„±
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON); // JSON í˜•ì‹ìœ¼ë¡œ ë³´ë‚¸ë‹¤ê³  ëª…ì‹œ
            headers.setBearerAuth(apiKey); // ì¸ì¦ì„ ìœ„í•œ API í‚¤ ì¶”ê°€

            // ë³¸ë¬¸ ë‚´ìš©(Body)ì™€ í—¤ë”(header)ë¥¼ í•˜ë‚˜ë¡œ í•©ì³ì„œ í•˜ë‚˜ì˜ ê°ì²´ë¡œ ë§Œë“¦
            HttpEntity<Map<String, Object>> request = new HttpEntity<>(requestBody, headers);

            // API í˜¸ì¶œ
            ResponseEntity<Map> response = restTemplate.exchange(
                    API_URL, // ì–´ë””ë¡œ ë³´ë‚¼ì§€ (OpenAI ì„œë²„)
                    HttpMethod.POST, // ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ë³´ë‚¼ì§€ (POST)
                    request, // ì–´ë–¤ ë°ì´í„°ë¥¼ ë³´ë‚¼ì§€ (ë³¸ë¬¸ + í—¤ë”)
                    Map.class // ì‘ë‹µì„ ì–´ë–¤ íƒ€ì…ìœ¼ë¡œ ë°›ì„ì§€ (Map)
            );

            // ì‘ë‹µì—ì„œ í•„ìš”í•œ ë©”ì‹œì§€ë¥¼ ì¶”ì¶œ
            List<Map<String, Object>> choices = (List<Map<String, Object>>) response.getBody().get("choices");
            Map<String, Object> message = (Map<String, Object>) choices.get(0).get("message");

            String content = (String) message.get("content"); // GPTì˜ ì‹¤ì œ ì‘ë‹µ í…ìŠ¤íŠ¸ë§Œ ë¦¬í„´

            // GPT ì‘ë‹µ ì¶”ê°€
            history.add(Map.of("role", "assistant", "content", content));

            return content;

        } catch (Exception e) {
            // ì˜ˆì™¸ ë°œìƒ ì‹œ ì½˜ì†”ì— ì—ëŸ¬ ì¶œë ¥
            e.printStackTrace();
            // ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤„ ì—ëŸ¬ ë©”ì‹œì§€ ë°˜í™˜
            return " GPT ì‘ë‹µ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        }

    }


    // ì´ˆê¸°í™” ë©”ì„œë“œ
    public void resetConversation(String mode) {
        conversationHistories.remove(mode);
        System.out.println("[" + mode + "] ëª¨ë“œ ëŒ€í™” ì´ˆê¸°í™”ë¨");
    }
}
